name: synth-mysql

on:
  push:
    branches: [ master ]
    paths: [ '**/*.rs' ]
  pull_request:
    branches: [ master ]
    paths: [ '**/*.rs' ]

  workflow_dispatch:

jobs:
  e2e_tests_mysql:
    runs-on: ubuntu-latest
    env:
      MYSQL_HOST: localhost
      MYSQL_USER: root
      MYSQL_PORT: 3306
      MYSQL_ROOT_PASSWORD: mysecretpassword
      MYSQL_DATABASE: test_db
    services:
      mysql:
        image: mysql
        env:
          MYSQL_ROOT_PASSWORD: ${{ env.MYSQL_ROOT_PASSWORD }}
          MYSQL_DATABASE: ${{ env.MYSQL_DATABASE }}
        ports:
          - ${{ env.MYSQL_PORT }}
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    steps:
      - uses: actions/checkout@v2
      - run: |
          sudo apt-get update
          sudo apt-get install --yes --no-install-recommends mysql-client jq
      - run: >
          mysql -h ${{ env.MYSQL_HOST }} -u ${{ env.MYSQL_USER }} --password=${{ env.MYSQL_ROOT_PASSWORD }}
          -P ${{ env.MYSQL_PORT }} test_db < synth/testing_harness/mysql/0_hospital_schema.sql
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly-2021-05-17
      - run: cargo +nightly-2021-05-17 install --debug --path=synth
      - run: |
          echo "Running generate test"
          cd synth/testing_harness/mysql
          synth init || true
          synth generate hospital_master --to mysql://${{ env.MYSQL_USER }}:${{ env.MYSQL_ROOT_PASSWORD }}@${{ env.MYSQL_HOST }}:${{ env.MYSQL_PORT }}/${{ env.MYSQL_DATABASE }} --size 30
          bash "${GITHUB_WORKSPACE}/.github/workflows/scripts/validate_mysql_gen_count.sh"
      - run: |
          echo "Testing import"
          cd synth/testing_harness/mysql
          synth init || true
          synth import --from mysql://${{ env.MYSQL_USER }}:${{ env.MYSQL_ROOT_PASSWORD }}@${{ env.MYSQL_HOST }}:${{ env.MYSQL_PORT }}/${{ env.MYSQL_DATABASE }} hospital_import
          diff <(jq --sort-keys . hospital_import/*) <(jq --sort-keys . hospital_master/*)

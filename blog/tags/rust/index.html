<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/synth/blog/rss.xml" title="Synth - Documentation Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/synth/blog/atom.xml" title="Synth - Documentation Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Synth - Documentation" href="/synth/opensearch.xml">
<script defer="defer" src="https://cdn.usefathom.com/script.js" spa="auto" site="ASXTKXUJ"></script><title data-react-helmet="true">Posts tagged &quot;rust&quot; | Synth - Blog</title><meta data-react-helmet="true" property="og:title" content="Posts tagged &quot;rust&quot; | Synth - Blog"><meta data-react-helmet="true" name="description" content="Blog | Tagged &quot;rust&quot;"><meta data-react-helmet="true" property="og:description" content="Blog | Tagged &quot;rust&quot;"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:image" content="https://live.staticflickr.com/2785/4317096083_24697db960_b.jpg"><meta data-react-helmet="true" name="twitter:image" content="https://live.staticflickr.com/2785/4317096083_24697db960_b.jpg"><meta data-react-helmet="true" name="twitter:image:alt" content="Image for Complex Procedural Rust Macros"><link data-react-helmet="true" rel="shortcut icon" href="/synth/img/getsynth_favicon.png"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/synth/styles.ff7856e5.css">
<link rel="preload" href="/synth/styles.8fc30a4f.js" as="script">
<link rel="preload" href="/synth/runtime~main.c088a259.js" as="script">
<link rel="preload" href="/synth/main.4bd9f922.js" as="script">
<link rel="preload" href="/synth/1.b452cd4b.js" as="script">
<link rel="preload" href="/synth/2.e6808580.js" as="script">
<link rel="preload" href="/synth/3.b58ca890.js" as="script">
<link rel="preload" href="/synth/01a85c17.d0c8050a.js" as="script">
<link rel="preload" href="/synth/57.5a9b031e.js" as="script">
<link rel="preload" href="/synth/6875c492.a5b9a0c2.js" as="script">
<link rel="preload" href="/synth/a6aa9e1f.848af18b.js" as="script">
<link rel="preload" href="/synth/b4f94a6c.0a902b76.js" as="script">
<link rel="preload" href="/synth/ccc49370.e8e4b686.js" as="script">
<link rel="preload" href="/synth/5992cf76.b40a0135.js" as="script">
<link rel="preload" href="/synth/e2182a6a.b7174997.js" as="script">
<link rel="preload" href="/synth/ddc4f683.fce403c6.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/synth/"><img src="/synth/img/getsynth_identicon.png" alt="Synth" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/synth/img/getsynth_identicon.png" alt="Synth" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Synth</strong></a><a class="navbar__item navbar__link" href="/synth/getting_started/synth">Getting Started</a><a class="navbar__item navbar__link" href="/synth/examples/bank">Examples</a><a class="navbar__item navbar__link" href="/synth/content/null">Generators</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/synth/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/getsynth/synth" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/synth/"><img src="/synth/img/getsynth_identicon.png" alt="Synth" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/synth/img/getsynth_identicon.png" alt="Synth" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Synth</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/synth/getting_started/synth">Getting Started</a></li><li class="menu__list-item"><a class="menu__link" href="/synth/examples/bank">Examples</a></li><li class="menu__list-item"><a class="menu__link" href="/synth/content/null">Generators</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/synth/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/getsynth/synth" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--2"><div class="sidebar_SWld thin-scrollbar"><h3 class="sidebarItemTitle_Km2m">Recent posts</h3><ul class="sidebarItemList_3UpA"><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/synth/blog/2021/08/09/macro">Complex Procedural Rust Macros</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/synth/blog/2021/08/04/test-data">Why not to use prod data for testing - and what to do instead</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/synth/blog/2021/03/09/postgres-data-gen">How to Create PostgreSQL Test Data</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/synth/blog/2021/03/08/mern">Create realistic test data for your web app</a></li></ul></div></div><main class="col col--8"><h1>1 post tagged with &quot;rust&quot;</h1><a href="/synth/blog/tags">View All Tags</a><div class="margin-vert--xl"><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/synth/blog/2021/08/09/macro">Complex Procedural Rust Macros</a></h2><div class="margin-vert--md"><time datetime="2021-08-09T00:00:00.000Z" class="blogPostDate_Ta7i">August 9, 2021  Â· 8 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/getsynth" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/4200835?v=4" alt="Andre Bogus"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/getsynth" target="_blank" rel="noreferrer noopener">Andre Bogus</a></h4><small class="avatar__subtitle">Chief Rustacean</small></div></div></header><section class="markdown"><p>I recently wrote the most complex procedural Rust macro Iâ€™ve ever attempted. This post tries to outline the problems Iâ€™ve encountered and tells how I overcame them.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="the-background"></a>The Background<a class="hash-link" href="#the-background" title="Direct link to heading">#</a></h2><p>With synth, we are building a declarative command line test data generator. For now, the specification that declares what test data to build is just JSON that gets deserialised to our data structures using <code>serde_json</code>. This was a quick and easy way to configure our application without much overhead in terms of code. For example:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_3RXF"><div tabindex="0" class="prism-code language-json codeBlock_1wn8 thin-scrollbar"><div class="codeBlockLines_3HrO" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;array&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;length&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;number&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;constant&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">3</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;content&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;object&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;id&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;number&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;id&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;name&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;string&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;faker&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;generator&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;name&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;email&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;string&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;faker&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;generator&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;ascii_email&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><div class="buttonsBlock_1QLD"><button type="button" aria-label="Copy code to clipboard" class="codeButton_2n6w copyButton_1PCb">Copy</button><button type="button" aria-label="Run code with Synth" class="codeButton_2n6w runButton_3F96">Run</button></div></div></div><p>However, itâ€™s also not very nice to write (for example JSON has no comments, no formulas, etc.), so we wanted to bind our specification to a scripting language. Our end goal is to extend the language (both in terms of builtin functions and syntax) to make the configuration really elegant. After some testing and benchmarking different runtimes, our choice fell on <a href="https://github.com/koto-lang/koto" target="_blank" rel="noopener noreferrer">koto</a>, a nice little scripting language that was built foremost for live coding. </p><p>Unfortunately, koto has a very bare interface to bind to external Rust code. Since we are talking about a rather large number of types we want to include, it was clear from the start that we would want to generate the code to bind to koto.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="early-beginnings"></a>Early Beginnings<a class="hash-link" href="#early-beginnings" title="Direct link to heading">#</a></h2><p>So I started with a somewhat simple macro to wrangle koto types (e.g. Maps) into our Rust types. However, I soon found that the marshalling overhead would have been fine for an initial setup phase, but not for recurrent calls into koto (for example for filter functions called for each row). Thus I changed my approach to try and bind functions, then extended that to types and impl blocks.</p><p>I found â€“ as I then thought â€“ a genius technique of generating functions that would call each other, thus daisy-chaining a series of code blocks into one that could then be called with another <code>bindlang_main!()</code> proc macro:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_3RXF"><div tabindex="0" class="prism-code language-rust codeBlock_1wn8 thin-scrollbar"><div class="codeBlockLines_3HrO" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">static FN_NUMBER: AtomicUsize = AtomicUsize::new(0);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">fn next_fn(mut b: Block, arg: &amp;Expr) -&gt; Item {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let number = FN_NUMBER.fetch_add(1, SeqCst);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let this_fn = fn_ident(number);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if let Some(n) = number.checked_sub(1) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let last_fn = fn_ident(n);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        b.stmts.push(parse_quote! { #last_fn(#arg); });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    b.stmts.extend(last_call);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    parse_quote! { fn #this_fn(#arg) { #b } }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#[proc_macro]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">fn bindlang_main(arg: TokenStream) -&gt; TokenStream {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let arg = ident(arg.to_string());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    TokenStream::from(if let Some(n) = FN_NUMBER.load(SeqCst).checked_sub(1) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let last_fn = fn_ident(n);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        quote! { #last_fn(#arg) }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    } else {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        proc_macro2::TokenStream::default()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    })</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><div class="buttonsBlock_1QLD"><button type="button" aria-label="Copy code to clipboard" class="codeButton_2n6w copyButton_1PCb">Copy</button></div></div></div><p>I also wrote a derive macro to implement the marshalling traits. This worked well for a small example that was entirely contained within one module, but failed once the code was spread out through multiple modules: The functions would no longer be in the same scope and therefore stopped finding each other.</p><p>Worse, I needed a number of pre-defined maps with functions for method dispatch for our external types within koto. A type in Rust can have an arbitrary number of impl blocks but I needed exactly <em>one</em> table, and I couldnâ€™t simply daisy-chain those.</p><p>It was clear I needed a different solution. After thinking long and hard I came to the conclusion that I needed to pull all the code together in one scope, by the <code>bindlang_main!()</code> macro. My idea was that I create a <code>HashMap</code> of <code>syn::Item</code>s to be quoted together into one <code>TokenStream</code>. A lazy static <code>Arc&lt;Mutex&lt;Vec&lt;Context&gt;&gt;&gt;</code> was to collect the information from multiple attribute invocations:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_3RXF"><div tabindex="0" class="prism-code language-rust codeBlock_1wn8 thin-scrollbar"><div class="codeBlockLines_3HrO" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#[derive(Default)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">struct Context {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    bare_fns: Vec&lt;MethodSig&gt;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    modules: HashMap&lt;String, Vec&lt;MethodSig&gt;&gt;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    vtables: HashMap&lt;String, Vec&lt;MethodSig&gt;&gt;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    types: HashMap&lt;String, String&gt;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">lazy_static::lazy_static! {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    static ref CONTEXT: Arc&lt;Mutex&lt;Context&gt;&gt; = Arc::new(Mutex::new(Context::default()));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#[proc_macro_attribute]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn bindlang(_attrs: TokenStream, code: TokenStream) -&gt; TokenStream {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let code_cloned = code.clone();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let input = parse_macro_input!(code_cloned as Item);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // evaluate input here, and store information in Context</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // CONTEXT.lock().unwrap()...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    code</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><div class="buttonsBlock_1QLD"><button type="button" aria-label="Copy code to clipboard" class="codeButton_2n6w copyButton_1PCb">Copy</button></div></div></div><p>This was when I found out that none of <code>syn</code>&#x27;s type is <code>Send</code> and therefore cannot be stored within a <code>Mutex</code>. My first attempt to circumvent this was moving everything to <code>String</code>s and using <code>syn::parse_str</code> to get the items out. This failed because of macro hygiene: Each identifier in Rust <code>proc_macro</code>s has an identity. Two identifiers resulting from two macro operations will get different identities, no matter if their textual representation is the same.</p><p>I also found that <code>proc_macro_derive</code>s have no way to get the <code>#[derive(..)]</code> attribute of the type, and I wanted to also bind derived trait implementations (at least for <code>Default</code>, because some types have no other constructors). So I removed the derive and moved the implementation to the <code>#[bindlang]</code> attribute macro, which now works on types, impl blocks and fns.</p><p><strong>Beware: This makes use of the (unspecified, but as of now working) top-down order of macro expansion to work!</strong></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="dirty-tricks-avoided"></a>Dirty tricks avoided<a class="hash-link" href="#dirty-tricks-avoided" title="Direct link to heading">#</a></h2><p>There is a <code>Span::mixed_context()</code> variant that will yield semi-hygienic macros (like with <code>macro_rules</code>). However, this looked risky (macro hygiene is there to protect us, so we better have a good reason to override it), so I took the data oriented approach, collecting the info I needed to create the code in the <code>lazy_static</code> to walk within <code>bindlang_main!()</code>. I still tried to generate the trait impls for marshalling directly in the attribute macro, but this again ran into macro hygiene trouble, because I could not recreate the virtual dispatch table identifiers. After moving this part to the main macro, too, the macro finally expanded successfully.</p><p>Except it didnâ€™t compile successfully.</p><p>I had forgotten to <code>use</code> the items I was creating code for in the macro, and koto requires all external types to implement <code>Display</code>. So I added those imports as macro arguments and added the <code>Display</code> <code>impl</code>s to be met with a type inference error within the macro invocation. Clearly I needed some type annotations, but the error message only showed me the macro invocation, which was pretty unhelpful.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="expanding-our-vision"></a>Expanding Our Vision<a class="hash-link" href="#expanding-our-vision" title="Direct link to heading">#</a></h2><p>My solution to debug those was to <code>cargo expand</code> the code, comment out the macro invocation and copy the expanded portions in its place so that my IDE would pinpoint the error for me. I had to manually un-expand some <code>format!</code> invocations so the code would resolve correctly, and finally found where I needed more type annotations. With those added, the code finally compiled. Whew!</p><p>I then extended the bindings to also cover trait impls and <code>Option</code>s, while my colleague Christos changed the code to marshall Rust values into koto values to mangle <code>Result::Err(_)</code> into kotoâ€™s runtime errors. Remembering that implicit constructors (structs and enum variants) are also useful, I added support to binding those if public. There was another error where intermediate code generated wouldn&#x27;t parse, but some <code>eprintln!</code> debugging helped pinpoint the piece of code where it happened.</p><p>When trying to bind functions taking a non <code>self</code> referenced argument (e.g. <code>fn from(value: &amp;Value) -&gt; Self</code>), I found that the bindings would not work, because my <code>FromValue</code> implementation could not get references. Remember, a function in Rust cannot return a borrow into a value that lives only within it. It took me a while to remember I <a href="https://llogiq.github.io/2015/08/19/closure.html" target="_blank" rel="noopener noreferrer">blogged</a> about the solution in 2015! Closures to the rescue! The basic idea is to have a function that takes a closure with a reference argument and return the result of that closure:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_3RXF"><div tabindex="0" class="prism-code language-rust codeBlock_1wn8 thin-scrollbar"><div class="codeBlockLines_3HrO" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub trait RefFromValue {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fn ref_from_value&lt;R, F: Fn(&amp;Self) -&gt; R&gt;(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        key_path: &amp;KeyPath&lt;&#x27;_&gt;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        value: &amp;Value,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        f: F,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ) -&gt; Result&lt;R, RuntimeError&gt;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><div class="buttonsBlock_1QLD"><button type="button" aria-label="Copy code to clipboard" class="codeButton_2n6w copyButton_1PCb">Copy</button></div></div></div><p>Having this in a separate trait allows us to distinguish types where the borrow isn&#x27;t <code>&amp;T</code>, e.g. for <code>&amp;str</code>. Also we gain a bit of simplicity by using unified function call syntax (<code>MyType::my_fn(..)</code> instead of <code>v0.my_fn</code>). This also meant I had to nest the argument parsing: I did this by creating the innermost <code>Expr</code> and wrap it in argument extractors in reverse argument order:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_3RXF"><div tabindex="0" class="prism-code language-rust codeBlock_1wn8 thin-scrollbar"><div class="codeBlockLines_3HrO" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">let mut expr: Expr = parse_quote! { #path(#(#inner_idents),*) };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">for (i, ((a, v), mode)) in idents.iter().zip(args.iter()).enumerate().rev() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    expr = if mode.is_ref() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        parse_quote! { </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            ::lang_bindings::RefFromValue::ref_from_value(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                &amp;::lang_bindings::KeyPath::Index(#i, None),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                #a,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                |#v| #expr</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            )?</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    } else {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        parse_quote! {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            match (::lang_bindings::FromValue::from_value(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                &amp;::lang_bindings::KeyPath::Index(#i, None),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                #a</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            )?) { </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                (#v) =&gt; #expr</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><div class="buttonsBlock_1QLD"><button type="button" aria-label="Copy code to clipboard" class="codeButton_2n6w copyButton_1PCb">Copy</button></div></div></div><p>Note that <code>match</code> in the <code>else</code> part is there to introduce a binding without requiring a <code>Block</code>, a common macro trick. Now all that was left to do was add <code>#[bindlang]</code> attributes to our <code>Namespace</code> and its contents, and also add a lot of <code>Display</code> implementations because koto requires this for all <code>ExternalValue</code> implementors.</p><p>In conclusion, our test configuration should now look something like:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_3RXF"><div tabindex="0" class="prism-code language-undefined codeBlock_1wn8 thin-scrollbar"><div class="codeBlockLines_3HrO" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">synth.Namespace({</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    synth.Name(&quot;users&quot;): synth.Content.Array (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            synth.Name(&quot;id&quot;): synth.Content.Number(NumberContent.Id(schema.Id)),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            synth.Name(&quot;name&quot;): synth.Content.String(StringContent.Faker(&quot;firstname&quot;, [&quot;EN&quot;])),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            synth.Name(&quot;email&quot;): synth.Content.String(StringContent.Faker(&quot;email&quot;, [&quot;EN&quot;])),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    synth.Content.Number(NumberContent.Constant(10))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    })</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">})</span></div></div></div><div class="buttonsBlock_1QLD"><button type="button" aria-label="Copy code to clipboard" class="codeButton_2n6w copyButton_1PCb">Copy</button></div></div></div><p>That&#x27;s only the beginning: I want to introduce a few coercions, a custom koto prelude and perhaps some syntactic sugar to make this even easier to both read and write.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="the-takeaway"></a>The Takeaway<a class="hash-link" href="#the-takeaway" title="Direct link to heading">#</a></h2><p>Macros that collect state to use later are possible (well, as long as the expansion order stays as it is) and useful, especially where code is strewn across various blocks (or even files or modules). However, if code relies on other code, it best be emitted in one go, otherwise module visibility and macro hygiene conspire to make life hard for the macro author. And if at one point the expansion order gets changed in a way that breaks the macro, I can change it to a standalone crate to be called from build.rs thanks to <code>proc_macro2</code> being decoupled from the actual implementation.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/synth/blog/tags/rust">rust</a><a class="margin-horiz--sm" href="/synth/blog/tags/macros">macros</a></div><div class="col text--right"><a aria-label="Read more about Complex Procedural Rust Macros" href="/synth/blog/2021/08/09/macro"><strong>Read More</strong></a></div></footer></article></div></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/synth/getting_started/synth">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/synth/examples/bank">Examples</a></li><li class="footer__item"><a class="footer__link-item" href="/synth/content/null">Generators</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 OpenQuery.</div></div></div></footer></div>
<script src="/synth/styles.8fc30a4f.js"></script>
<script src="/synth/runtime~main.c088a259.js"></script>
<script src="/synth/main.4bd9f922.js"></script>
<script src="/synth/1.b452cd4b.js"></script>
<script src="/synth/2.e6808580.js"></script>
<script src="/synth/3.b58ca890.js"></script>
<script src="/synth/01a85c17.d0c8050a.js"></script>
<script src="/synth/57.5a9b031e.js"></script>
<script src="/synth/6875c492.a5b9a0c2.js"></script>
<script src="/synth/a6aa9e1f.848af18b.js"></script>
<script src="/synth/b4f94a6c.0a902b76.js"></script>
<script src="/synth/ccc49370.e8e4b686.js"></script>
<script src="/synth/5992cf76.b40a0135.js"></script>
<script src="/synth/e2182a6a.b7174997.js"></script>
<script src="/synth/ddc4f683.fce403c6.js"></script>
<script>window.Papercups={config:{accountId:"41ff5b3d-e2c2-42ed-bed3-ef7a6c0dde62",baseUrl:"https://app.papercups.io",greeting:"",newMessagePlaceholder:"Start typing...",primaryColor:"#00dab8",requireEmailUpfront:!1,showAgentAvailability:!1,subtitle:"Ask us anything in the chat window below ðŸ˜Š",title:"Welcome to Synth"}}</script>
<style>
              @media (max-width: 996px) {
                .Papercups-toggleButtonContainer {
                  bottom: 80px;
                }

                .Papercups-chatWindowContainer {
                  bottom: 160px;
                }
              }
            </style>
<script async defer="defer" src="https://app.papercups.io/widget.js"></script></body>
</html>